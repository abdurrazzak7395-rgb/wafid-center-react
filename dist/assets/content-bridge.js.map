{"version":3,"file":"content-bridge.js","sources":["../../src/content-bridge.ts"],"sourcesContent":["(() => {\n  const allowedOrigins = new Set([\"http://localhost:3000\", \"https://wafid.com\"]);\n\n  const requestType = \"automation-run-row\";\n  const responseType = \"automation-result\";\n  const defaultTimeout = 60000;\n\n  const isAllowedOrigin = (origin: string) => allowedOrigins.size === 0 || allowedOrigins.has(origin);\n\n  const pendingRequests = new Map();\n\n  window.addEventListener(\"message\", (event) => {\n    console.log(event, 'event')\n    try {\n      if (!isAllowedOrigin(event.origin)) {\n        console.warn(\"[BRIDGE] blocked origin:\", event.origin);\n        return;\n      }\n\n      const data = event.data;\n\n      if (!data || typeof data !== \"object\" || data.type !== requestType) return;\n\n      const { requestId, index, row, timeoutMs } = data;\n\n      if (!requestId || pendingRequests.has(requestId)) return;\n\n      const timerId = setTimeout(() => {\n        pendingRequests.delete(requestId);\n        const timeoutResponse = {\n          type: responseType,\n          requestId,\n          ok: false,\n          error: \"Timeout waiting for background response\",\n          _via: \"content-bridge-timeout\",\n        };\n        window.postMessage(timeoutResponse, event.origin);\n      }, timeoutMs ?? defaultTimeout);\n\n      pendingRequests.set(requestId, { origin: event.origin, timerId });\n\n      chrome.runtime.sendMessage({ type: requestType, requestId, index, row }, (response) => {\n        const lastError = chrome.runtime?.lastError;\n        const requestEntry = pendingRequests.get(requestId);\n        if (!requestEntry) return;\n\n        clearTimeout(requestEntry.timerId);\n        pendingRequests.delete(requestId);\n\n        const payload = response && typeof response === \"object\"\n          ? { ...response, _via: \"content-bridge\" }\n          : {\n              type: responseType,\n              requestId,\n              ok: !lastError,\n              error: lastError?.message ?? (response == null ? \"No response\" : undefined),\n              _via: \"content-bridge\",\n            };\n\n        try {\n          window.postMessage(payload, requestEntry.origin);\n        } catch (error) {\n          console.error(\"[BRIDGE] postMessage back failed:\", error);\n        }\n      });\n    } catch (error) {\n      try {\n        const requestId = event?.data?.requestId ?? `req_${Date.now()}`;\n        const errorPayload = {\n          type: responseType,\n          requestId,\n          ok: false,\n          error: String(error),\n          _via: \"content-bridge-catch\",\n        };\n        console.error(\"[BRIDGE] exception:\", errorPayload);\n        window.postMessage(errorPayload, event.origin || \"*\");\n      } catch (e) {\n        console.error(\"[BRIDGE] exception notify failed:\", e);\n      }\n    }\n  });\n\n  try {\n    window.postMessage({ type: \"bridge-ready\", at: Date.now() }, \"*\");\n  } catch (error) {\n    console.warn(\"[BRIDGE] bridge-ready post failed:\", error);\n  }\n})();\n"],"names":["allowedOrigins","requestType","responseType","defaultTimeout","isAllowedOrigin","origin","pendingRequests","event","data","requestId","index","row","timeoutMs","timerId","timeoutResponse","response","lastError","requestEntry","payload","error","errorPayload"],"mappings":"CAAC,IAAM,CACL,MAAMA,EAAiB,IAAI,IAAI,CAAC,wBAAyB,mBAAmB,CAAC,EAEvEC,EAAc,qBACdC,EAAe,oBACfC,EAAiB,IAEjBC,EAAmBC,GAAmBL,EAAe,OAAS,GAAKA,EAAe,IAAIK,CAAM,EAE5FC,MAAsB,IAE5B,OAAO,iBAAiB,UAAYC,GAAU,CAC5C,QAAQ,IAAIA,EAAO,OAAO,EAC1B,GAAI,CACF,GAAI,CAACH,EAAgBG,EAAM,MAAM,EAAG,CAClC,QAAQ,KAAK,2BAA4BA,EAAM,MAAM,EACrD,MACF,CAEA,MAAMC,EAAOD,EAAM,KAEnB,GAAI,CAACC,GAAQ,OAAOA,GAAS,UAAYA,EAAK,OAASP,EAAa,OAEpE,KAAM,CAAE,UAAAQ,EAAW,MAAAC,EAAO,IAAAC,EAAK,UAAAC,GAAcJ,EAE7C,GAAI,CAACC,GAAaH,EAAgB,IAAIG,CAAS,EAAG,OAElD,MAAMI,EAAU,WAAW,IAAM,CAC/BP,EAAgB,OAAOG,CAAS,EAChC,MAAMK,EAAkB,CACtB,KAAMZ,EACN,UAAAO,EACA,GAAI,GACJ,MAAO,0CACP,KAAM,wBAAA,EAER,OAAO,YAAYK,EAAiBP,EAAM,MAAM,CAClD,EAAGK,GAAaT,CAAc,EAE9BG,EAAgB,IAAIG,EAAW,CAAE,OAAQF,EAAM,OAAQ,QAAAM,EAAS,EAEhE,OAAO,QAAQ,YAAY,CAAE,KAAMZ,EAAa,UAAAQ,EAAW,MAAAC,EAAO,IAAAC,GAAQI,GAAa,CACrF,MAAMC,EAAY,OAAO,SAAS,UAC5BC,EAAeX,EAAgB,IAAIG,CAAS,EAClD,GAAI,CAACQ,EAAc,OAEnB,aAAaA,EAAa,OAAO,EACjCX,EAAgB,OAAOG,CAAS,EAEhC,MAAMS,EAAUH,GAAY,OAAOA,GAAa,SAC5C,CAAE,GAAGA,EAAU,KAAM,kBACrB,CACE,KAAMb,EACN,UAAAO,EACA,GAAI,CAACO,EACL,MAAOA,GAAW,UAAYD,GAAY,KAAO,cAAgB,QACjE,KAAM,gBAAA,EAGZ,GAAI,CACF,OAAO,YAAYG,EAASD,EAAa,MAAM,CACjD,OAASE,EAAO,CACd,QAAQ,MAAM,oCAAqCA,CAAK,CAC1D,CACF,CAAC,CACH,OAASA,EAAO,CACd,GAAI,CACF,MAAMV,EAAYF,GAAO,MAAM,WAAa,OAAO,KAAK,KAAK,GACvDa,EAAe,CACnB,KAAMlB,EACN,UAAAO,EACA,GAAI,GACJ,MAAO,OAAOU,CAAK,EACnB,KAAM,sBAAA,EAER,QAAQ,MAAM,sBAAuBC,CAAY,EACjD,OAAO,YAAYA,EAAcb,EAAM,QAAU,GAAG,CACtD,OAAS,EAAG,CACV,QAAQ,MAAM,oCAAqC,CAAC,CACtD,CACF,CACF,CAAC,EAED,GAAI,CACF,OAAO,YAAY,CAAE,KAAM,eAAgB,GAAI,KAAK,KAAI,EAAK,GAAG,CAClE,OAASY,EAAO,CACd,QAAQ,KAAK,qCAAsCA,CAAK,CAC1D,CACF,GAAA"}